name: Auto Releaser By MicroResearch Corporation

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *' # Daily at 00:00 UTC

permissions:
  contents: write

concurrency:
  group: auto-release
  cancel-in-progress: false

jobs:
  auto-release:
    runs-on: ubuntu-latest

    steps:
      # ------------------------------
      # 1. Checkout
      # ------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ------------------------------
      # 2. Get latest release date
      # ------------------------------
      - name: Get latest release date
        id: latest
        uses: actions/github-script@v7
        with:
          script: |
            try {
              const r = await github.rest.repos.getLatestRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
              });
              core.setOutput('published_at', r.data.published_at);
            } catch {
              core.setOutput('published_at', '');
            }

      # ------------------------------
      # 3. Decide if release is needed
      # ------------------------------
      - name: Decide release
        id: decide
        run: |
          TODAY=$(date -u +'%Y.%m.%d')
          echo "DATE=$TODAY" >> $GITHUB_ENV

          if [ -z "${{ steps.latest.outputs.published_at }}" ]; then
            echo "release=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          LAST=$(date -d "${{ steps.latest.outputs.published_at }}" +%s)
          NOW=$(date +%s)
          DAYS=$(( (NOW - LAST) / 86400 ))

          echo "Days since last release: $DAYS"

          if [ "$DAYS" -ge 1 ]; then
            echo "release=true" >> $GITHUB_OUTPUT
          else
            echo "release=false" >> $GITHUB_OUTPUT
          fi

      # ------------------------------
      # 4. Prevent duplicate tags
      # ------------------------------
      - name: Check tag existence
        if: steps.decide.outputs.release == 'true'
        id: tagcheck
        run: |
          TAG="v${DATE}"
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      # ------------------------------
      # 5. Prepare release files
      # ------------------------------
      - name: Prepare files
        if: |
          steps.decide.outputs.release == 'true' &&
          steps.tagcheck.outputs.exists == 'false'
        run: |
          rm -rf release
          mkdir release
          rsync -a \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='.vscode' \
            --exclude='.gitignore' \
            --exclude='package.json' \
            --exclude='Structure.md' \
            ./ release/

      # ------------------------------
      # 6. Zip package
      # ------------------------------
      - name: Create ZIP
        if: |
          steps.decide.outputs.release == 'true' &&
          steps.tagcheck.outputs.exists == 'false'
        run: |
          ZIP="release_${DATE}.zip"
          zip -qr "$ZIP" release
          echo "ZIP=$ZIP" >> $GITHUB_ENV

      # ------------------------------
      # 7. Generate release notes
      # ------------------------------
      - name: Release notes
        if: |
          steps.decide.outputs.release == 'true' &&
          steps.tagcheck.outputs.exists == 'false'
        run: |
          cat <<EOF > notes.txt
          Release v${DATE}

          Author: M Ramzan Ch
          Company: MicroResearch Corporation
          Released By: MR Intelligence
          Published By: Pro Badney
          EOF

          echo "NOTES<<EOF" >> $GITHUB_ENV
          cat notes.txt >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      # ------------------------------
      # 8. Create GitHub release
      # ------------------------------
      - name: Publish release
        if: |
          steps.decide.outputs.release == 'true' &&
          steps.tagcheck.outputs.exists == 'false'
        uses: ncipollo/release-action@v1
        with:
          tag: v${{ env.DATE }}
          name: v${{ env.DATE }}
          body: ${{ env.NOTES }}
          files: ${{ env.ZIP }}
          draft: false
          prerelease: false
