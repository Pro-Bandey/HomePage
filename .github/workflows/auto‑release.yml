name: Auto Releaser By MicroResearch Corporation

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

permissions:
  contents: write

jobs:
  auto-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # Step 1: Get latest release date
      - name: Get latest release date
        id: get_release
        uses: actions/github-script@v7
        with:
          script: |
            const core = require('@actions/core');
            try {
              const release = await github.rest.repos.getLatestRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
              });
              core.setOutput('published_at', release.data.published_at);
            } catch (e) {
              core.setOutput('published_at', '');
            }

      # Step 2: Check if 3 days passed
      - name: Check if 3 days passed
        id: check_days
        run: |
          if [ -z "${{ steps.get_release.outputs.published_at }}" ]; then
            echo "should_release=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          release_ts=$(date -d "${{ steps.get_release.outputs.published_at }}" +%s)
          now_ts=$(date +%s)
          diff_days=$(( (now_ts - release_ts) / 86400 ))

          echo "Days since last release: $diff_days"

          if [ "$diff_days" -ge 3 ]; then
            echo "should_release=true" >> $GITHUB_OUTPUT
          else
            echo "should_release=false" >> $GITHUB_OUTPUT
          fi

      # Step 3: Set date variables
      - name: Set release variables
        if: steps.check_days.outputs.should_release == 'true'
        run: |
          echo "RELEASE_DATE=$(date +'%Y.%m.%d')" >> $GITHUB_ENV
          echo "ZIP_FILE=release_$(date +'%Y.%m.%d').zip" >> $GITHUB_ENV

      # Step 4: Prepare project files
      - name: Prepare project files
        if: steps.check_days.outputs.should_release == 'true'
        run: |
          rm -rf release
          mkdir release
          rsync -av \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='.vscode' \
            --exclude='.gitignore' \
            --exclude='package.json' \
            --exclude='Structure.md' \
            ./ release/

      # Step 5: Create ZIP package
      - name: Create ZIP package
        if: steps.check_days.outputs.should_release == 'true'
        run: |
          zip -r "$ZIP_FILE" release

      # Step 6: Generate release notes
      - name: Generate release notes
        if: steps.check_days.outputs.should_release == 'true'
        run: |
          cat <<EOF > release_notes.txt
          Release v${RELEASE_DATE}

          Author: M Ramzan Ch
          Company: MicroResearch Corporation
          Released By: MR Intelligence
          Published By: Pro Badney
          EOF

          echo "RELEASE_NOTES<<EOF" >> $GITHUB_ENV
          cat release_notes.txt >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      # Step 7: Publish GitHub release
      - name: Create GitHub Release
        if: steps.check_days.outputs.should_release == 'true'
        uses: ncipollo/release-action@v1
        with:
          tag: v${{ env.RELEASE_DATE }}
          name: v${{ env.RELEASE_DATE }}
          body: ${{ env.RELEASE_NOTES }}
          files: ${{ env.ZIP_FILE }}
          draft: false
          prerelease: false
